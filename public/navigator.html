// public/navigator.js
(() => {
  const $ = (id) => document.getElementById(id);

  const messagesEl = $("messages");
  const inputEl = $("input");
  const sendBtn = $("send");
  const ageInput = $("ageInput");

  const infoBtn = $("infoBtn");
  const modalOverlay = $("modalOverlay");
  const closeModal = $("closeModal");
  const modalBody = $("modalBody");

  let history = [];

  function nowHHMM() {
    const d = new Date();
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return `${hh}:${mm}`;
  }

  function openInfo() {
    modalBody.innerHTML = `
      <p>
        This navigator is built for teens who are growing up without a father or with a father
        who is emotionally absent. It does not search the whole internet. Instead, it draws
        only from a curated database of programs, hotlines, therapy options, and peer spaces
        that have been reviewed in advance.
      </p>
      <p>
        The AI does one job: it reads your message, compares it to the database, and suggests a
        few options that seem like the best fit for what you described. It explains why each
        match makes sense and names concrete first steps, such as calling, texting, filling out
        a short form, or asking for a referral.
      </p>
      <p>
        The navigator is not a crisis service and cannot see your identity. If you are in
        immediate danger or thinking about harming yourself, call or text <strong>988</strong>
        or local emergency services instead of relying on this tool.
      </p>
      <p>
        To see more about how resources are chosen, you can read
        <a href="https://sinepatre.com/how-we-choose-resources" target="_blank" rel="noreferrer">
          How we choose resources
        </a>
        on the main SinePatre site.
      </p>
    `;
    modalOverlay.classList.add("open");
  }

  function closeInfo() {
    modalOverlay.classList.remove("open");
  }

  infoBtn.addEventListener("click", openInfo);
  closeModal.addEventListener("click", closeInfo);
  modalOverlay.addEventListener("click", (e) => {
    if (e.target === modalOverlay) closeInfo();
  });

  function addMessage(role, text, extraNode) {
    const row = document.createElement("div");
    row.className = `msgRow ${role}`;

    const bubble = document.createElement("div");
    bubble.className = `bubble ${role}`;

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = `${role === "user" ? "You" : "Navigator"} · ${nowHHMM()}`;

    const content = document.createElement("div");
    content.textContent = text;

    bubble.appendChild(meta);
    bubble.appendChild(content);

    if (extraNode) bubble.appendChild(extraNode);

    row.appendChild(bubble);
    messagesEl.appendChild(row);

    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function makeCards(resources) {
    const wrap = document.createElement("div");
    wrap.className = "cards";

    resources.forEach((r) => {
      const card = document.createElement("div");
      card.className = "card";

      const top = document.createElement("div");
      top.className = "cardTop";

      const title = document.createElement("p");
      title.className = "cardTitle";
      title.textContent = r.title || "Resource";

      const link = document.createElement("a");
      link.className = "cardLink";
      link.href = r.url;
      link.target = "_blank";
      link.rel = "noreferrer";
      link.textContent = "Open";

      top.appendChild(title);
      top.appendChild(link);

      const why = document.createElement("div");
      why.className = "cardWhy";

      const full = String(r.why || "").trim();
      const short = full.length > 220 ? `${full.slice(0, 220).trim()}…` : full;

      const textNode = document.createElement("div");
      textNode.textContent = short;
      why.appendChild(textNode);

      if (full.length > 220) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "showMoreBtn";
        btn.textContent = "Show more";
        let expanded = false;

        btn.addEventListener("click", () => {
          expanded = !expanded;
          textNode.textContent = expanded ? full : short;
          btn.textContent = expanded ? "Show less" : "Show more";
        });

        why.appendChild(btn);
      }

      const steps = Array.isArray(r.how_to_start) ? r.how_to_start : [];
      if (steps.length) {
        const pills = document.createElement("div");
        pills.className = "howToStart";

        steps.slice(0, 5).forEach((s) => {
          const pill = document.createElement("span");
          pill.className = "stepPill";
          pill.textContent = `How to start: ${s}`;
          pills.appendChild(pill);
        });

        card.appendChild(top);
        card.appendChild(why);
        card.appendChild(pills);
      } else {
        card.appendChild(top);
        card.appendChild(why);
      }

      wrap.appendChild(card);
    });

    return wrap;
  }

  function setSending(isSending) {
    sendBtn.disabled = isSending;
    inputEl.disabled = isSending;
  }

  async function sendMessage() {
    const raw = String(inputEl.value || "").trim();
    const age = String(ageInput.value || "").trim();

    if (!raw) return;

    // What user sees
    addMessage("user", raw);

    // What API sees
    const messageForApi = age ? `Age range: ${age}. ${raw}` : raw;
    history.push({ role: "user", content: messageForApi });

    inputEl.value = "";
    inputEl.style.height = "auto";

    setSending(true);

    try {
      const response = await fetch("/api/navigate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: messageForApi,
          history,
        }),
      });

      const data = await response.json();

      if (data.mode === "clarify" && data.question) {
        const text = `${data.intro || ""}\n\n${data.question}`;
        addMessage("assistant", text.trim());
        history.push({ role: "assistant", content: text.trim() });
        return;
      }

      if (data.mode === "safety") {
        const cards = makeCards(data.resources || []);
        addMessage(
          "assistant",
          data.intro || "You deserve immediate support. Please use one of these options.",
          cards
        );
        history.push({
          role: "assistant",
          content: data.intro || "Safety resources shared.",
        });
        return;
      }

      if (data.mode === "no_match") {
        addMessage(
          "assistant",
          data.intro ||
            "I am not seeing a strong match yet. Add one more detail so I can refine the search."
        );
        history.push({
          role: "assistant",
          content:
            data.intro ||
            "No strong match yet. Asked the user for a bit more detail.",
        });
        return;
      }

      const intro = data.intro || "Here is what fits best based on what you shared.";
      const resources = Array.isArray(data.resources) ? data.resources : [];

      if (!resources.length) {
        addMessage("assistant", intro);
        history.push({ role: "assistant", content: intro });
        return;
      }

      const cards = makeCards(resources);
      addMessage("assistant", intro, cards);
      history.push({ role: "assistant", content: intro });
    } catch (e) {
      addMessage(
        "assistant",
        "Something went wrong while loading matches. Try again in a moment."
      );
      history.push({
        role: "assistant",
        content: "Error while calling the navigator.",
      });
    } finally {
      setSending(false);
    }
  }

  // Autosize textarea
  inputEl.addEventListener("input", () => {
    inputEl.style.height = "auto";
    inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + "px";
  });

  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      void sendMessage();
    }
  });

  sendBtn.addEventListener("click", () => {
    void sendMessage();
  });

  // Opening line from the navigator
  const introText =
    "Tell me what is happening and what you would like next. I will suggest one to three options and explain how to begin with each.";
  addMessage("assistant", introText);
  history.push({ role: "assistant", content: introText });
})();
