<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SinePatre Resource Navigator</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap');

    :root{
      --bg: #0f0f10;
      --panel: rgba(255,255,255,0.06);
      --panelBorder: rgba(255,255,255,0.12);
      --muted: rgba(255,255,255,0.70);
      --muted2: rgba(255,255,255,0.50);
      --hairline: rgba(255,255,255,0.10);

      --youBg: rgba(255,255,255,0.92);
      --youText: #111;

      --aiBg: rgba(0,0,0,0.24);
      --aiText: rgba(255,255,255,0.92);

      --btnBg: rgba(255,255,255,0.06);
      --btnBorder: rgba(255,255,255,0.14);
      --btnHover: rgba(255,255,255,0.10);

      --shadow: rgba(0,0,0,0.28);
    }

    *{ box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      background: var(--bg);
      color: #fff;
      font-family: 'EB Garamond', Georgia, serif;
      letter-spacing: -0.01em;
    }

    .bgGlow::before{
      content: "";
      position: fixed;
      inset: -40% -20% auto auto;
      width: 720px;
      height: 720px;
      background: radial-gradient(circle, rgba(255,255,255,0.06) 0%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }
    .bgGlow::after{
      content: "";
      position: fixed;
      inset: auto auto -42% -18%;
      width: 660px;
      height: 660px;
      background: radial-gradient(circle, rgba(255,255,255,0.035) 0%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }

    .wrap{
      position: relative;
      z-index: 1;
      width: min(980px, calc(100% - 48px));
      margin: 0 auto;
      padding: 44px 0 54px;
    }

    .top{
      text-align: center;
      margin-bottom: 22px;
    }

    .markRow{
      display: inline-flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
      opacity: 0.95;
    }

    .mark{
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.06);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08);
    }

    .mark svg{
      width: 16px;
      height: 16px;
      stroke: rgba(255,255,255,0.78);
      stroke-width: 2;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .chip{
      font-size: 12px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.72);
      border: 1px solid rgba(255,255,255,0.22);
      padding: 8px 16px;
      border-radius: 999px;
      background: transparent;
    }

    h1{
      margin: 10px 0 12px;
      font-weight: 500;
      font-size: clamp(34px, 4.8vw, 56px);
      line-height: 1.08;
      letter-spacing: -0.02em;
    }

    .desc{
      margin: 0 auto;
      max-width: 780px;
      color: var(--muted);
      font-size: 17px;
      line-height: 1.65;
    }

    .desc strong{
      color: rgba(255,255,255,0.92);
      font-weight: 700;
    }

    .shell{
      margin: 26px auto 0;
      max-width: 900px;
      background: var(--panel);
      border: 1px solid var(--panelBorder);
      border-radius: 22px;
      box-shadow: 0 18px 60px var(--shadow), inset 0 1px 0 rgba(255,255,255,0.06);
      overflow: hidden;
    }

    .chat{
      padding: 16px 16px 10px;
      height: min(58vh, 560px);
      overflow: auto;
    }

    .divider{ height: 1px; background: var(--hairline); }

    .row{
      display: flex;
      gap: 10px;
      align-items: flex-end;
      padding: 12px;
    }

    .inputWrap{
      flex: 1;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 10px 12px;
      min-height: 52px;
    }

    textarea{
      width: 100%;
      border: none;
      outline: none;
      resize: none;
      background: transparent;
      color: rgba(255,255,255,0.90);
      font-family: 'EB Garamond', Georgia, serif;
      font-size: 18px;
      line-height: 1.5;
      padding: 0;
      margin: 0;
      min-height: 30px;
      max-height: 140px;
    }

    textarea::placeholder{ color: rgba(255,255,255,0.45); }

    .miniActions{
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .circleBtn{
      width: 42px;
      height: 42px;
      border-radius: 999px;
      border: 1px solid var(--btnBorder);
      background: var(--btnBg);
      color: rgba(255,255,255,0.88);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 160ms ease, background 160ms ease, border-color 160ms ease;
      position: relative;
      user-select: none;
    }

    .circleBtn:hover{
      transform: translateY(-1px);
      background: var(--btnHover);
      border-color: rgba(255,255,255,0.20);
    }

    .circleBtn:disabled{
      opacity: 0.55;
      cursor: not-allowed;
      transform: none;
    }

    .circleBtn svg{
      width: 18px;
      height: 18px;
      stroke: currentColor;
      stroke-width: 2;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .tooltip{
      position: absolute;
      left: 50%;
      bottom: 52px;
      transform: translateX(-50%);
      background: rgba(10,10,11,0.92);
      border: 1px solid rgba(255,255,255,0.14);
      color: rgba(255,255,255,0.92);
      padding: 7px 10px;
      border-radius: 10px;
      font-size: 12px;
      letter-spacing: 0.02em;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 140ms ease;
    }

    .circleBtn:hover .tooltip{ opacity: 1; }

    .hint{
      padding: 10px 16px 14px;
      color: var(--muted2);
      font-size: 13px;
    }

    .hint code{
      color: rgba(255,255,255,0.72);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
    }

    .msg{
      display: flex;
      margin: 10px 0;
    }
    .msg.you{ justify-content: flex-start; }
    .msg.ai{ justify-content: flex-end; }

    .bubble{
      max-width: min(760px, 86%);
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      font-size: 17px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .you .bubble{
      background: var(--youBg);
      color: var(--youText);
      border-color: rgba(255,255,255,0.16);
    }

    .ai .bubble{
      background: var(--aiBg);
      color: var(--aiText);
      border-color: rgba(255,255,255,0.12);
    }

    .typing{
      opacity: 0.8;
      font-style: italic;
    }

    @media (max-width: 620px){
      .wrap{ width: calc(100% - 28px); padding: 34px 0 44px; }
      textarea{ font-size: 16px; }
      .bubble{ font-size: 16px; }
      .chat{ height: min(62vh, 560px); }
    }
  </style>
</head>

<body class="bgGlow">
  <div class="wrap">
    <div class="top">
      <div class="markRow">
        <span class="mark" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path d="M12 21s-7-4.6-7-11a4 4 0 0 1 7-2 4 4 0 0 1 7 2c0 6.4-7 11-7 11z"></path>
          </svg>
        </span>
        <span class="chip">Resource Navigator</span>
      </div>

      <h1>Find support that actually fits</h1>

      <p class="desc">
        A private conversation for fatherless teens who want clarity, not noise.
        Tell me what is happening and what you want next, and I will help you sort it into a few realistic options.
        If you are in immediate danger, or thinking about harming yourself, call or text <strong>988</strong> right now.
      </p>
    </div>

    <div class="shell" role="application" aria-label="SinePatre chat">
      <div id="chat" class="chat" aria-live="polite"></div>
      <div class="divider"></div>

      <div class="row">
        <div class="inputWrap">
          <textarea id="input" placeholder="Write a message…" rows="1"></textarea>
        </div>

        <div class="miniActions">
          <button id="newChat" class="circleBtn" type="button" aria-label="Create new chat">
            <span class="tooltip">Create new chat</span>
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 5v14"></path>
              <path d="M5 12h14"></path>
            </svg>
          </button>

          <button id="send" class="circleBtn" type="button" aria-label="Send message">
            <span class="tooltip">Send</span>
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M5 12h12"></path>
              <path d="M13 6l6 6-6 6"></path>
            </svg>
          </button>
        </div>
      </div>

      <div class="hint">
        Press <code>Enter</code> to send, <code>Shift + Enter</code> for a new line.
      </div>
    </div>
  </div>

  <script>
    const chatEl = document.getElementById("chat");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const newBtn = document.getElementById("newChat");

    let history = [];

    function addMessage(role, text, opts = {}) {
      const wrap = document.createElement("div");
      wrap.className = "msg " + (role === "user" ? "you" : "ai");

      const bubble = document.createElement("div");
      bubble.className = "bubble" + (opts.typing ? " typing" : "");
      bubble.textContent = text;

      wrap.appendChild(bubble);
      chatEl.appendChild(wrap);
      chatEl.scrollTop = chatEl.scrollHeight;

      return bubble;
    }

    function setSending(isSending) {
      sendBtn.disabled = isSending;
      newBtn.disabled = isSending;
    }

    function autosize() {
      inputEl.style.height = "0px";
      const h = Math.min(inputEl.scrollHeight, 140);
      inputEl.style.height = h + "px";
    }

    function trimHistory() {
      history = history
        .filter(m => m && (m.role === "user" || m.role === "assistant") && typeof m.content === "string")
        .slice(-10);
    }

    async function send() {
      const message = (inputEl.value || "").trim();
      if (!message) return;

      addMessage("user", message);
      history.push({ role: "user", content: message });
      trimHistory();

      inputEl.value = "";
      autosize();
      setSending(true);

      const typingBubble = addMessage("assistant", "…", { typing: true });

      const controller = new AbortController();
      const timeoutMs = 12000; // fail fast
      const t = setTimeout(() => controller.abort(), timeoutMs);

      try {
        const res = await fetch("/api/navigate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message, history }),
          signal: controller.signal,
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || data?.detail || "Request failed");

        const reply = (data.reply || "").trim() ||
          "Tell me a little more about what you want most right now, and what would feel doable this week.";

        typingBubble.classList.remove("typing");
        typingBubble.textContent = reply;

        history.push({ role: "assistant", content: reply });
        trimHistory();
      } catch (err) {
        typingBubble.classList.remove("typing");
        typingBubble.textContent =
          "That request took too long. Try again. If it keeps happening, check your Vercel logs for /api/navigate and confirm your API key is set.";
      } finally {
        clearTimeout(t);
        setSending(false);
        chatEl.scrollTop = chatEl.scrollHeight;
      }
    }

    function newChat() {
      history = [];
      chatEl.innerHTML = "";
      inputEl.value = "";
      autosize();
      inputEl.focus();
    }

    sendBtn.addEventListener("click", send);
    newBtn.addEventListener("click", newChat);

    inputEl.addEventListener("input", autosize);
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    // No starter message, start clean
    newChat();
  </script>
</body>
</html>
