// public/navigator.js
(() => {
  const TOPICS = [
    "talk now",
    "therapy",
    "support group",
    "mentor",
    "grief",
    "school stress",
    "anxiety",
    "depression",
    "family",
    "identity",
  ];

  const $ = (id) => document.getElementById(id);

  const messagesEl = $("messages");
  const inputEl = $("input");
  const sendBtn = $("send");
  const goalSelect = $("goalSelect");
  const ageInput = $("ageInput");

  const infoBtn = $("infoBtn");
  const howBtn = $("howBtn");
  const modalOverlay = $("modalOverlay");
  const closeModal = $("closeModal");
  const modalTitle = $("modalTitle");
  const modalBody = $("modalBody");

  let selectedTags = new Set();
  let history = [];

  function nowHHMM() {
    const d = new Date();
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return `${hh}:${mm}`;
  }

  function openModal(title, html) {
    modalTitle.textContent = title;
    modalBody.innerHTML = html;
    modalOverlay.classList.add("open");
  }

  function closeModalFn() {
    modalOverlay.classList.remove("open");
  }

  closeModal.addEventListener("click", closeModalFn);
  modalOverlay.addEventListener("click", (e) => {
    if (e.target === modalOverlay) closeModalFn();
  });

  infoBtn.addEventListener("click", () => {
    openModal(
      "Info",
      `
        <p>
          This tool matches you to a curated list of resources for fatherless teens.
          It only recommends items from that database.
        </p>
        <p>
          If you are in immediate danger or thinking about harming yourself, call or text <strong>988</strong>.
        </p>
      `
    );
  });

  howBtn.addEventListener("click", () => {
    openModal(
      "How we choose resources",
      `
        <p>
          We include resources that are reputable, teen-appropriate, and clear about how to start.
          We prioritize options that are safe, specific, and practical to access.
        </p>
        <p>
          <a href="https://sinepatre.com/how-we-choose-resources" target="_blank" rel="noreferrer">
            Read more
          </a>
        </p>
      `
    );
  });

  function addMessage(role, text, extraNode) {
    const row = document.createElement("div");
    row.className = `msgRow ${role}`;

    const bubble = document.createElement("div");
    bubble.className = `bubble ${role}`;

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = `${role === "user" ? "You" : "Navigator"} · ${nowHHMM()}`;

    const content = document.createElement("div");
    content.textContent = text;

    bubble.appendChild(meta);
    bubble.appendChild(content);

    if (extraNode) bubble.appendChild(extraNode);

    row.appendChild(bubble);
    messagesEl.appendChild(row);

    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function makeCards(resources) {
    const wrap = document.createElement("div");
    wrap.className = "cards";

    resources.forEach((r) => {
      const card = document.createElement("div");
      card.className = "card";

      const top = document.createElement("div");
      top.className = "cardTop";

      const title = document.createElement("p");
      title.className = "cardTitle";
      title.textContent = r.title || "Resource";

      const link = document.createElement("a");
      link.className = "cardLink";
      link.href = r.url;
      link.target = "_blank";
      link.rel = "noreferrer";
      link.textContent = "Open";

      top.appendChild(title);
      top.appendChild(link);

      const why = document.createElement("div");
      why.className = "cardWhy";

      const full = String(r.why || "").trim();
      const short = full.length > 220 ? `${full.slice(0, 220).trim()}…` : full;

      const whyText = document.createElement("div");
      whyText.textContent = short;

      why.appendChild(whyText);

      if (full.length > 220) {
        const btn = document.createElement("button");
        btn.className = "showMoreBtn";
        btn.type = "button";
        btn.textContent = "Show more";
        let expanded = false;

        btn.addEventListener("click", () => {
          expanded = !expanded;
          whyText.textContent = expanded ? full : short;
          btn.textContent = expanded ? "Show less" : "Show more";
        });

        why.appendChild(btn);
      }

      const steps = Array.isArray(r.how_to_start) ? r.how_to_start : [];
      if (steps.length) {
        const pills = document.createElement("div");
        pills.className = "howToStart";

        steps.slice(0, 5).forEach((s) => {
          const pill = document.createElement("span");
          pill.className = "stepPill";
          pill.textContent = `How to start: ${s}`;
          pills.appendChild(pill);
        });

        card.appendChild(top);
        card.appendChild(why);
        card.appendChild(pills);
      } else {
        card.appendChild(top);
        card.appendChild(why);
      }

      wrap.appendChild(card);
    });

    return wrap;
  }

  function setSending(isSending) {
    sendBtn.disabled = isSending;
    inputEl.disabled = isSending;
  }

  function currentSelections() {
    const goal = String(goalSelect.value || "").trim();
    const age_range = String(ageInput.value || "").trim();
    return {
      selected_tags: Array.from(selectedTags),
      goal,
      age_range,
    };
  }

  async function sendMessage() {
    const text = String(inputEl.value || "").trim();
    const { selected_tags, goal, age_range } = currentSelections();

    if (!text && selected_tags.length === 0 && !goal && !age_range) return;

    if (text) {
      addMessage("user", text);
      history.push({ role: "user", content: text });
    } else {
      addMessage("user", `Selected topics: ${selected_tags.join(", ") || "none"}`);
      history.push({
        role: "user",
        content: `Selected topics: ${selected_tags.join(", ") || "none"}. Goal: ${goal || "n/a"}. Age range: ${
          age_range || "n/a"
        }.`,
      });
    }

    inputEl.value = "";
    inputEl.style.height = "auto";

    setSending(true);

    try {
      const r = await fetch("/api/navigate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: text,
          history,
          selected_tags,
          goal,
          age_range,
        }),
      });

      const data = await r.json();

      if (data.mode === "clarify" && data.question) {
        addMessage("assistant", `${data.intro}\n\n${data.question}`);
        history.push({ role: "assistant", content: `${data.intro}\n\n${data.question}` });
        return;
      }

      if (data.mode === "safety") {
        const cards = makeCards(data.resources || []);
        addMessage("assistant", data.intro || "Please use one of these resources now.", cards);
        history.push({ role: "assistant", content: data.intro || "Safety resources provided." });
        return;
      }

      if (data.mode === "no_match") {
        addMessage("assistant", data.intro || "Add one detail so I can match you.");
        history.push({ role: "assistant", content: data.intro || "No match." });
        return;
      }

      const intro = data.intro || "Here is what fits best.";
      const resources = Array.isArray(data.resources) ? data.resources : [];

      if (!resources.length) {
        addMessage("assistant", intro);
        history.push({ role: "assistant", content: intro });
        return;
      }

      const cards = makeCards(resources);
      addMessage("assistant", intro, cards);
      history.push({ role: "assistant", content: intro });
    } catch (e) {
      addMessage("assistant", "Something went wrong. Please try again.");
      history.push({ role: "assistant", content: "Something went wrong." });
    } finally {
      setSending(false);
    }
  }

  // Autosize textarea
  inputEl.addEventListener("input", () => {
    inputEl.style.height = "auto";
    inputEl.style.height = Math.min(inputEl.scrollHeight, 160) + "px";
  });

  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      void sendMessage();
    }
  });

  sendBtn.addEventListener("click", () => void sendMessage());

  // Topic chips
  document.querySelectorAll(".chip[data-tag]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const tag = String(btn.getAttribute("data-tag") || "").trim().toLowerCase();
      if (!TOPICS.includes(tag)) return;

      if (selectedTags.has(tag)) {
        selectedTags.delete(tag);
        btn.classList.remove("active");
      } else {
        selectedTags.add(tag);
        btn.classList.add("active");
      }
    });
  });

  // First message
  addMessage(
    "assistant",
    "Pick a topic above, then tell me what is going on. I will return 1 to 3 best-fit options and exactly how to start."
  );
  history.push({
    role: "assistant",
    content:
      "Pick a topic above, then tell me what is going on. I will return 1 to 3 best-fit options and exactly how to start.",
  });
})();
