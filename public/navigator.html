<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SinePatre Resource Navigator</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap');

    :root{
      --ink: #0a0a0b;
      --muted: rgba(255,255,255,0.70);
      --muted2: rgba(255,255,255,0.55);
      --panel: rgba(255,255,255,0.055);
      --panelBorder: rgba(255,255,255,0.12);
      --field: rgba(0,0,0,0.20);
      --fieldBorder: rgba(255,255,255,0.14);
      --hairline: rgba(255,255,255,0.10);
      --white: #ffffff;
    }

    *{ box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      font-family: 'EB Garamond', Georgia, serif;
      background: #0f0f10;
      color: #fff;
      letter-spacing: -0.01em;
    }

    /* HERO */
    .hero{
      min-height: 100vh;
      display: flex;
      align-items: center;
      padding: 84px 0 72px;
      position: relative;
      overflow: hidden;
    }

    .hero::before{
      content: '';
      position: absolute;
      top: -45%;
      right: -12%;
      width: 680px;
      height: 680px;
      background: radial-gradient(circle, rgba(255,255,255,0.06) 0%, transparent 70%);
      pointer-events: none;
    }

    .hero::after{
      content: '';
      position: absolute;
      bottom: -40%;
      left: -8%;
      width: 560px;
      height: 560px;
      background: radial-gradient(circle, rgba(255,255,255,0.035) 0%, transparent 70%);
      pointer-events: none;
    }

    .wrap{
      width: min(980px, 100%);
      margin: 0 auto;
      padding: 0 22px;
      position: relative;
      z-index: 1;
    }

    .top{
      text-align: center;
      margin-bottom: 26px;
    }

    .chip{
      display: inline-block;
      padding: 10px 22px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.28);
      background: transparent;
      color: rgba(255,255,255,0.72);
      font-size: 12px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      font-weight: 500;
      margin-bottom: 18px;
    }

    h1{
      margin: 0 0 14px;
      font-weight: 400;
      font-size: 64px;
      line-height: 1.08;
      letter-spacing: -0.02em;
    }

    .desc{
      margin: 0 auto;
      max-width: 840px;
      color: rgba(255,255,255,0.70);
      font-size: 18px;
      line-height: 1.65;
      letter-spacing: 0.15px;
    }

    .desc strong{ color: rgba(255,255,255,0.92); font-weight: 700; }

    /* PANEL */
    .panel{
      margin: 26px auto 0;
      background: var(--panel);
      border: 1px solid var(--panelBorder);
      border-radius: 18px;
      padding: 16px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
      backdrop-filter: blur(8px);
    }

    .transcript{
      height: min(46vh, 420px);
      overflow: auto;
      padding: 10px 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--hairline);
      background: rgba(0,0,0,0.16);
    }

    .line{
      margin: 0;
      padding: 10px 6px;
      font-size: 17px;
      line-height: 1.6;
      color: rgba(255,255,255,0.92);
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .line:last-child{ border-bottom: none; }

    .who{
      display: inline-block;
      min-width: 92px;
      color: rgba(255,255,255,0.62);
      letter-spacing: 0.04em;
    }

    .line.assistant .who{ color: rgba(255,255,255,0.70); }
    .line.user .who{ color: rgba(255,255,255,0.58); }

    .composer{
      display: flex;
      gap: 10px;
      align-items: flex-end;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }

    .input{
      flex: 1;
      border-radius: 14px;
      border: 1px solid var(--fieldBorder);
      background: var(--field);
      padding: 12px 12px;
      color: rgba(255,255,255,0.92);
      outline: none;
      font-family: 'EB Garamond', Georgia, serif;
      font-size: 18px;
      line-height: 1.45;
      resize: none;
      min-height: 48px;
      max-height: 140px;
      overflow: auto;
    }

    .input::placeholder{ color: rgba(255,255,255,0.48); }

    .actions{
      display: flex;
      gap: 10px;
      align-items: center;
      padding-bottom: 2px;
    }

    .iconBtn{
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 160ms ease, background 160ms ease, border-color 160ms ease, opacity 160ms ease;
      position: relative;
      user-select: none;
    }

    .iconBtn:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,0.10);
      border-color: rgba(255,255,255,0.18);
    }

    .iconBtn:disabled{
      opacity: 0.55;
      cursor: not-allowed;
      transform: none;
    }

    .iconBtn svg{
      width: 18px;
      height: 18px;
      fill: none;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    /* Tooltip (hover) */
    .iconBtn[data-tip]::after{
      content: attr(data-tip);
      position: absolute;
      bottom: 54px;
      right: 0;
      background: rgba(10,10,11,0.92);
      color: rgba(255,255,255,0.92);
      border: 1px solid rgba(255,255,255,0.14);
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 13px;
      line-height: 1.2;
      white-space: nowrap;
      opacity: 0;
      transform: translateY(6px);
      pointer-events: none;
      transition: opacity 140ms ease, transform 140ms ease;
      box-shadow: 0 16px 40px rgba(0,0,0,0.35);
    }

    .iconBtn[data-tip]:hover::after{
      opacity: 1;
      transform: translateY(0);
    }

    .subnote{
      margin-top: 10px;
      color: rgba(255,255,255,0.55);
      font-size: 14px;
      line-height: 1.55;
    }
    .subnote strong{ color: rgba(255,255,255,0.90); font-weight: 700; }

    /* Responsive */
    @media (max-width: 820px){
      h1{ font-size: clamp(38px, 6vw, 52px); }
      .desc{ font-size: 16px; }
      .transcript{ height: min(48vh, 420px); }
    }
  </style>
</head>

<body>
  <section class="hero">
    <div class="wrap">
      <div class="top">
        <div class="chip">Resource Navigator</div>
        <h1>Find support that actually fits</h1>
        <p class="desc">
          This is a private, conversational guide built for fatherless teens who want something more precise than generic links.
          Tell the navigator what is happening, what you want next, and what kind of support feels realistic right now.
          It will respond thoughtfully and recommend a short, high-fit set of vetted options, with clear reasoning and next steps.
          If you are in immediate danger, or thinking about harming yourself, call or text <strong>988</strong> right now.
        </p>
      </div>

      <div class="panel">
        <div id="transcript" class="transcript" aria-live="polite" aria-label="Chat transcript">
          <p class="line assistant">
            <span class="who">Navigator</span>
            Start anywhere. If it helps, say what you are feeling, what you want, and what kind of support would feel doable this week.
          </p>
        </div>

        <div class="composer" role="group" aria-label="Message composer">
          <textarea
            id="input"
            class="input"
            rows="1"
            placeholder="Write your message. Press Enter to send, Shift+Enter for a new line."
          ></textarea>

          <div class="actions">
            <button id="newChat" class="iconBtn" type="button" data-tip="Create new chat" aria-label="Create new chat">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 5v14"></path>
                <path d="M5 12h14"></path>
              </svg>
            </button>

            <button id="send" class="iconBtn" type="button" data-tip="Send" aria-label="Send message">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M5 12h13"></path>
                <path d="M13 5l7 7-7 7"></path>
              </svg>
            </button>
          </div>
        </div>

        <div class="subnote">
          The clearer you are about what you want, someone to talk to, coping skills, grief support, mentorship, community, therapy options, the better the match.
        </div>
      </div>
    </div>
  </section>

  <script>
    const transcriptEl = document.getElementById("transcript");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const newChatBtn = document.getElementById("newChat");

    // In-memory chat history (also sent to your API; safe if your API ignores it).
    let history = [
      { role: "assistant", content: "Start anywhere. If it helps, say what you are feeling, what you want, and what kind of support would feel doable this week." }
    ];

    function appendLine(role, text){
      const p = document.createElement("p");
      p.className = "line " + (role === "assistant" ? "assistant" : "user");

      const who = document.createElement("span");
      who.className = "who";
      who.textContent = role === "assistant" ? "Navigator" : "You";

      const content = document.createElement("span");
      content.textContent = text;

      p.appendChild(who);
      p.appendChild(content);
      transcriptEl.appendChild(p);

      // Scroll to bottom
      transcriptEl.scrollTop = transcriptEl.scrollHeight;
    }

    function setBusy(isBusy){
      sendBtn.disabled = isBusy;
      newChatBtn.disabled = isBusy;
    }

    function autoGrow(el){
      el.style.height = "auto";
      el.style.height = Math.min(el.scrollHeight, 140) + "px";
    }

    function resetComposer(){
      inputEl.value = "";
      inputEl.style.height = "auto";
      inputEl.focus();
    }

    function clearChat(){
      transcriptEl.innerHTML = "";
      appendLine("assistant", "Start anywhere. If it helps, say what you are feeling, what you want, and what kind of support would feel doable this week.");
      history = [
        { role: "assistant", content: "Start anywhere. If it helps, say what you are feeling, what you want, and what kind of support would feel doable this week." }
      ];
      resetComposer();
    }

    async function send(){
      const message = (inputEl.value || "").trim();
      if (!message) return;

      appendLine("user", message);
      history.push({ role: "user", content: message });

      resetComposer();
      setBusy(true);

      // Lightweight typing line (single line, not a bubble)
      const typingId = "typing-" + Math.random().toString(16).slice(2);
      const typingLine = document.createElement("p");
      typingLine.className = "line assistant";
      typingLine.id = typingId;

      const who = document.createElement("span");
      who.className = "who";
      who.textContent = "Navigator";

      const content = document.createElement("span");
      content.textContent = "Thinkingâ€¦";

      typingLine.appendChild(who);
      typingLine.appendChild(content);
      transcriptEl.appendChild(typingLine);
      transcriptEl.scrollTop = transcriptEl.scrollHeight;

      try{
        const controller = new AbortController();

        // If your API sometimes hangs, this prevents endless waiting.
        const timeout = setTimeout(() => controller.abort(), 30000);

        const res = await fetch("/api/navigate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          signal: controller.signal,
          body: JSON.stringify({
            message,
            history // your backend can use this for better conversational continuity
          })
        });

        clearTimeout(timeout);

        const data = await res.json().catch(() => ({}));
        if (!res.ok){
          throw new Error(data?.error || data?.detail || "Request failed");
        }

        // Remove typing line
        const t = document.getElementById(typingId);
        if (t) t.remove();

        // Accept a few possible shapes, so you do not get stuck if backend changes.
        // Preferred: { reply: "..." }
        // Fallbacks: { text: "..." } or { intro: "...", resources:[...] } etc.
        let reply =
          data?.reply ||
          data?.text ||
          data?.response ||
          data?.assistant ||
          "";

        // If your endpoint still returns recommendations format, convert it into chat text.
        if (!reply && (Array.isArray(data?.resources) || data?.intro)){
          const intro = data?.intro ? String(data.intro).trim() : "";
          const resources = Array.isArray(data.resources) ? data.resources : [];
          const lines = [];

          if (intro) lines.push(intro);

          if (resources.length){
            lines.push("");
            lines.push("Here are the best matches for what you described:");
            lines.push("");
            resources.slice(0, 8).forEach((r, i) => {
              const title = r.title || r.name || "Resource";
              const why = r.why || r.reason || r.description || "";
              const url = r.url || r.website || "";
              const chunk = [
                (i+1) + ". " + title,
                why ? "   " + why : "",
                url ? "   " + url : ""
              ].filter(Boolean).join("\n");
              lines.push(chunk);
              lines.push("");
            });
          }

          reply = lines.join("\n").trim();
        }

        if (!reply){
          reply = "I received an empty response from the server. Check your Vercel logs for /api/navigate.";
        }

        appendLine("assistant", reply);
        history.push({ role: "assistant", content: reply });

      } catch (err){
        // Remove typing line if present
        const t = document.getElementById(typingId);
        if (t) t.remove();

        const msg =
          (err && err.name === "AbortError")
            ? "That request took too long. Try again, and if it keeps happening, you will want to speed up /api/navigate."
            : "Something went wrong. Check Vercel Runtime Logs for /api/navigate and confirm your environment variables are set.";

        appendLine("assistant", msg);
        history.push({ role: "assistant", content: msg });
      } finally {
        setBusy(false);
        inputEl.focus();
      }
    }

    // Events
    sendBtn.addEventListener("click", send);
    newChatBtn.addEventListener("click", clearChat);

    inputEl.addEventListener("input", () => autoGrow(inputEl));

    // Enter to send, Shift+Enter for newline
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });

    // Start focused
    inputEl.focus();
  </script>
</body>
</html>
