// public/navigator.js

(() => {
  const messagesEl = document.getElementById("messages");
  const inputEl = document.getElementById("input");
  const sendBtn = document.getElementById("sendBtn");
  const ageEl = document.getElementById("age");
  const clearBtn = document.getElementById("clearBtn");

  const infoBtn = document.getElementById("infoBtn");
  const infoModal = document.getElementById("infoModal");
  const closeInfo = document.getElementById("closeInfo");

  /** @type {{role:"user"|"assistant", content:string}[]} */
  let history = [];

  function nowStamp() {
    const d = new Date();
    return d.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
  }

  function autoGrow(el) {
    el.style.height = "auto";
    el.style.height = Math.min(el.scrollHeight, 140) + "px";
  }

  function escapeText(s) {
    const div = document.createElement("div");
    div.textContent = String(s ?? "");
    return div.innerHTML;
  }

  function addMessage(role, content, opts = {}) {
    const row = document.createElement("div");
    row.className = `msgRow ${role}`;

    const bubble = document.createElement("div");
    bubble.className = `bubble ${role === "user" ? "user" : ""}`;

    const meta = document.createElement("div");
    meta.className = "meta";

    const who = document.createElement("span");
    who.textContent = role === "user" ? "You" : "Navigator";

    const time = document.createElement("span");
    time.textContent = opts.time || nowStamp();

    meta.appendChild(who);
    meta.appendChild(time);

    const body = document.createElement("div");
    body.className = "content";
    body.textContent = content;

    bubble.appendChild(meta);
    bubble.appendChild(body);

    row.appendChild(bubble);
    messagesEl.appendChild(row);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function addResourceCards(resources) {
    if (!Array.isArray(resources) || !resources.length) return;

    const row = document.createElement("div");
    row.className = "msgRow assistant";

    const bubble = document.createElement("div");
    bubble.className = "bubble";

    const meta = document.createElement("div");
    meta.className = "meta";
    const who = document.createElement("span");
    who.textContent = "Matches";
    const time = document.createElement("span");
    time.textContent = nowStamp();
    meta.appendChild(who);
    meta.appendChild(time);

    const cards = document.createElement("div");
    cards.className = "cards";

    resources.forEach((r) => {
      const card = document.createElement("div");
      card.className = "card";

      const titleRow = document.createElement("div");
      titleRow.className = "cardTitle";

      const a = document.createElement("a");
      a.href = r.url;
      a.target = "_blank";
      a.rel = "noreferrer";
      a.textContent = r.title;

      titleRow.appendChild(a);

      const how = document.createElement("div");
      how.className = "howToStart";

      const steps = Array.isArray(r.how_to_start) ? r.how_to_start : [];
      steps.slice(0, 4).forEach((s) => {
        const pill = document.createElement("span");
        pill.className = "pill";
        pill.textContent = s;
        how.appendChild(pill);
      });

      const why = document.createElement("div");
      why.className = "why";

      const full = String(r.why || "").trim();
      const short = full.length > 240 ? full.slice(0, 240).trimEnd() + "â€¦" : full;

      const textSpan = document.createElement("span");
      textSpan.innerHTML = escapeText(short);

      const moreRow = document.createElement("div");
      moreRow.className = "moreRow";

      if (full.length > 240) {
        const btn = document.createElement("button");
        btn.className = "linkBtn";
        btn.type = "button";
        btn.textContent = "Show more";

        let expanded = false;
        btn.addEventListener("click", () => {
          expanded = !expanded;
          btn.textContent = expanded ? "Show less" : "Show more";
          textSpan.innerHTML = escapeText(expanded ? full : short);
        });

        moreRow.appendChild(btn);
      }

      why.appendChild(textSpan);

      card.appendChild(titleRow);
      if (steps.length) card.appendChild(how);
      card.appendChild(why);
      if (moreRow.childNodes.length) card.appendChild(moreRow);

      cards.appendChild(card);
    });

    bubble.appendChild(meta);
    bubble.appendChild(cards);
    row.appendChild(bubble);

    messagesEl.appendChild(row);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function setBusy(b) {
    sendBtn.disabled = b;
    inputEl.disabled = b;
    ageEl.disabled = b;
    clearBtn.disabled = b;
  }

  function openInfo() {
    infoModal.classList.add("open");
  }
  function closeInfoModal() {
    infoModal.classList.remove("open");
  }

  async function send() {
    const msg = inputEl.value.trim();
    if (!msg) return;

    addMessage("user", msg);
    history.push({ role: "user", content: msg });

    inputEl.value = "";
    autoGrow(inputEl);
    setBusy(true);

    try {
      const res = await fetch("/api/navigate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: msg,
          history,
          age: ageEl.value.trim(),
          topics: [],
        }),
      });

      const data = await res.json().catch(() => ({}));

      if (data && data.mode === "safety") {
        addMessage("assistant", data.intro || "Please use one of these resources now.");
        history.push({ role: "assistant", content: data.intro || "" });
        addResourceCards(data.resources || []);
        setBusy(false);
        inputEl.focus();
        return;
      }

      if (data && data.mode === "recommendations") {
        if (data.intro) {
          addMessage("assistant", data.intro);
          history.push({ role: "assistant", content: data.intro });
        }

        if (data.clarifying_question) {
          addMessage("assistant", data.clarifying_question);
          history.push({ role: "assistant", content: data.clarifying_question });
        }

        addResourceCards(data.resources || []);
        setBusy(false);
        inputEl.focus();
        return;
      }

      if (data && data.mode === "no_match") {
        addMessage("assistant", data.intro || "Tell me one more detail so I can narrow it down.");
        history.push({ role: "assistant", content: data.intro || "" });
        setBusy(false);
        inputEl.focus();
        return;
      }

      addMessage("assistant", "Something went wrong. Please try again.");
      setBusy(false);
      inputEl.focus();
    } catch {
      addMessage("assistant", "Something went wrong. Please try again.");
      setBusy(false);
      inputEl.focus();
    }
  }

  function clearChat() {
    messagesEl.innerHTML = "";
    history = [];
    inputEl.value = "";
    autoGrow(inputEl);
    inputEl.focus();
  }

  // Events
  inputEl.addEventListener("input", () => autoGrow(inputEl));
  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      send();
    }
  });

  sendBtn.addEventListener("click", send);
  clearBtn.addEventListener("click", clearChat);

  infoBtn.addEventListener("click", openInfo);
  closeInfo.addEventListener("click", closeInfoModal);
  infoModal.addEventListener("click", (e) => {
    if (e.target === infoModal) closeInfoModal();
  });

  // Init
  autoGrow(inputEl);
  inputEl.focus();
})();
