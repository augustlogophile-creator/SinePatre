<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Youth Fatherless Network Navigator</title>
  <style>
    :root{
      --bg:#071a33;               /* solid navy */
      --panel:#0b2444;
      --panel2:#0a213e;
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --border:rgba(234,240,255,.12);
      --shadow:rgba(0,0,0,.35);
      --accent:#ffffff;
      --danger:#ff5a5f;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      overflow:hidden;
    }

    .wrap{
      height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      padding:44px 18px 18px;
      gap:18px;
    }

    .hero{
      width:min(980px, 100%);
      text-align:center;
      padding:4px 10px;
    }

    .title{
      margin:0;
      font-weight:700;
      letter-spacing:-0.02em;
      font-size:clamp(28px, 4vw, 58px);
      line-height:1.05;
    }

    .desc{
      margin:14px auto 0;
      max-width:820px;
      font-size:clamp(14px, 1.55vw, 18px);
      line-height:1.55;
      color:var(--muted);
    }

    .chatShell{
      width:min(980px, 100%);
      flex:1;
      display:flex;
      flex-direction:column;
      border-radius:28px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      box-shadow:0 18px 70px var(--shadow);
      overflow:hidden;
      min-height:420px;
    }

    .messages{
      flex:1;
      overflow:auto;
      padding:22px 22px 16px;
      scroll-behavior:smooth;
    }

    .row{
      display:flex;
      margin:10px 0;
      gap:10px;
    }
    .row.user{ justify-content:flex-end; }
    .row.assistant{ justify-content:flex-start; }

    .bubble{
      max-width:78%;
      border-radius:18px;
      padding:12px 14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      line-height:1.5;
      font-size:15px;
    }
    .row.user .bubble{
      background:rgba(255,255,255,.06);
    }

    .cards{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:12px;
    }

    .card{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      border-radius:18px;
      padding:14px 14px 12px;
    }

    .cardTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:8px;
    }

    .cardTitle{
      font-weight:700;
      font-size:16px;
      letter-spacing:-0.01em;
      margin:0;
    }

    .openLink{
      color:var(--text);
      opacity:.85;
      text-decoration:underline;
      text-underline-offset:3px;
      font-weight:600;
      white-space:nowrap;
      cursor:pointer;
    }
    .openLink:hover{ opacity:1; }

    .cardLine{
      margin:8px 0 0;
      color:var(--muted);
      font-size:14px;
      line-height:1.55;
    }

    .cardLine strong{
      color:var(--text);
      font-weight:700;
    }

    /* Input area */
    .composer{
      padding:14px;
      border-top:1px solid var(--border);   /* subtle, no ugly thick bar */
      background:rgba(255,255,255,.02);     /* same vibe, still solid navy behind */
    }

    .composerInner{
      display:flex;
      align-items:center;
      gap:10px;
      border:1px solid var(--border);
      border-radius:18px;
      padding:10px 10px;
      background:rgba(255,255,255,.035);
      box-shadow:0 10px 45px rgba(0,0,0,.18) inset;
    }

    .input{
      flex:1;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:15px;
      padding:10px 10px;
      resize:none;
      height:44px;
      max-height:120px;
      line-height:1.4;
    }
    .input::placeholder{ color:rgba(234,240,255,.55); }

    .btn{
      border:none;
      outline:none;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:44px;
      height:44px;
      border-radius:14px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      color:var(--text);
      transition:transform .04s ease, opacity .15s ease;
      user-select:none;
    }
    .btn:active{ transform:scale(.98); }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; }

    .btnSend{
      background:var(--accent);
      color:#0b1630;
      border-color:rgba(255,255,255,.22);
    }

    .btnCrisis{
      background:rgba(255,90,95,.14);
      border-color:rgba(255,90,95,.35);
      color:var(--danger);
    }

    .hint{
      margin-top:8px;
      color:rgba(234,240,255,.52);
      font-size:12.5px;
      padding-left:6px;
    }

    /* mobile tweaks */
    @media (max-width:560px){
      .bubble{ max-width:92%; }
      .messages{ padding:18px 14px 14px; }
      .chatShell{ border-radius:22px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1 class="title">Youth Fatherless Network</h1>
      <p class="desc">
        Describe what you need, and this will pull the best matching resources from Youth Fatherless Network’s database.
        You can ask follow-up questions, and it will keep narrowing to what fits.
      </p>
    </div>

    <div class="chatShell" role="region" aria-label="Chat">
      <div id="messages" class="messages"></div>

      <div class="composer">
        <div class="composerInner">
          <button id="btnCrisis" class="btn btnCrisis" title="Get help now" aria-label="Get help now">
            <!-- warning icon -->
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 9v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 17h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M10.3 4.9 2.6 19.2c-.6 1.1.2 2.4 1.5 2.4h15.8c1.3 0 2.1-1.3 1.5-2.4L13.7 4.9c-.7-1.2-2.7-1.2-3.4 0Z" stroke="currentColor" stroke-width="2"/>
            </svg>
          </button>

          <textarea id="input" class="input" placeholder="Ask anything..." rows="1"></textarea>

          <button id="btnSend" class="btn btnSend" title="Send" aria-label="Send">
            <!-- arrow icon -->
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M5 12h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M13 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        <div class="hint">Enter to send, Shift + Enter for a new line.</div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = "/api/navigate"; // adjust if needed

    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("input");
    const btnSend = document.getElementById("btnSend");
    const btnCrisis = document.getElementById("btnCrisis");

    let history = [];
    let isSending = false;

    function scrollToBottom(){
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function addBubble(role, text){
      const row = document.createElement("div");
      row.className = "row " + role;

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;

      row.appendChild(bubble);
      messagesEl.appendChild(row);
      scrollToBottom();
    }

    function addCards(cards){
      const row = document.createElement("div");
      row.className = "row assistant";

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      const wrap = document.createElement("div");
      wrap.className = "cards";

      cards.forEach(c => {
        const card = document.createElement("div");
        card.className = "card";

        const top = document.createElement("div");
        top.className = "cardTop";

        const title = document.createElement("h3");
        title.className = "cardTitle";
        title.textContent = c.title || "Resource";

        const link = document.createElement("a");
        link.className = "openLink";
        link.textContent = "Open link";
        link.href = c.url || "#";
        link.target = "_blank";
        link.rel = "noopener noreferrer";

        top.appendChild(title);
        top.appendChild(link);

        const desc = document.createElement("p");
        desc.className = "cardLine";
        desc.innerHTML = "<strong>Description:</strong> " + (c.description || "");

        const why = document.createElement("p");
        why.className = "cardLine";
        why.innerHTML = "<strong>Why it matches what you’re looking for:</strong> " + (c.why || "");

        const next = document.createElement("p");
        next.className = "cardLine";
        next.innerHTML = "<strong>Next steps:</strong> " + (c.next_steps || "");

        card.appendChild(top);
        card.appendChild(desc);
        card.appendChild(why);
        card.appendChild(next);

        wrap.appendChild(card);
      });

      bubble.appendChild(wrap);
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      scrollToBottom();
    }

    function setSending(state){
      isSending = state;
      btnSend.disabled = state;
      btnCrisis.disabled = state;
    }

    async function sendMessage(){
      const text = inputEl.value.trim();
      if (!text || isSending) return;

      inputEl.value = "";
      inputEl.style.height = "44px";
      addBubble("user", text);

      history.push({ role: "user", content: text });
      history = history.slice(-30);

      setSending(true);

      try{
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text, history })
        });

        const data = await res.json();

        // Always add exactly one assistant bubble per response,
        // then optionally cards. This prevents the duplicated “prompt” look.
        const replyText = (data && data.reply) ? String(data.reply) : "Sorry, something went wrong.";
        addBubble("assistant", replyText);

        history.push({ role: "assistant", content: replyText });
        history = history.slice(-30);

        if (Array.isArray(data.cards) && data.cards.length){
          addCards(data.cards);
        }
      }catch(e){
        addBubble("assistant", "Sorry, I couldn’t load resources right now. Please try again.");
      }finally{
        setSending(false);
      }
    }

    // Buttons
    btnSend.addEventListener("click", sendMessage);

    btnCrisis.addEventListener("click", () => {
      window.open("https://didihirsch.org/teenline/", "_blank", "noopener,noreferrer");
    });

    // Enter to send, Shift+Enter for newline
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        sendMessage();
      }
    });

    // Auto-grow textarea
    inputEl.addEventListener("input", () => {
      inputEl.style.height = "44px";
      inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + "px";
    });

    // Initial assistant message (one time)
    addBubble("assistant", "Hi. Tell me what you’re looking for, and I’ll pull the best matches from the database.");
  </script>
</body>
</html>
