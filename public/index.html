<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SinePatre Resource Navigator</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700;800&display=swap');

    :root{
      --ink: #0a0a0b;
      --muted: #7a7a7f;
    }

    *{ box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      background: #ffffff;
      color: var(--ink);
      font-family: 'EB Garamond', Georgia, serif;
      letter-spacing: -0.01em;
      min-height: 100vh;
    }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
    }

    /* HERO */
    .hero{
      background: #1a1a1a;
      color: #ffffff;
      padding: 110px 0 90px;
      position: relative;
      overflow: hidden;
    }

    .hero::before{
      content: '';
      position: absolute;
      top: -40%;
      right: -10%;
      width: 600px;
      height: 600px;
      background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
      pointer-events: none;
    }

    .hero::after{
      content: '';
      position: absolute;
      bottom: -30%;
      left: -5%;
      width: 520px;
      height: 520px;
      background: radial-gradient(circle, rgba(255,255,255,0.03) 0%, transparent 70%);
      pointer-events: none;
    }

    .hero-inner{
      max-width: 920px;
      margin: 0 auto;
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .chip{
      display: inline-block;
      padding: 12px 28px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.3);
      background: transparent;
      color: rgba(255,255,255,0.7);
      font-size: 12px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      font-weight: 500;
      margin-bottom: 28px;
    }

    .hero h1{
      margin: 0 0 22px;
      font-weight: 400;
      font-size: 64px;
      line-height: 1.15;
      letter-spacing: -0.02em;
      color: #ffffff;
    }

    .hero p{
      margin: 0 auto 34px;
      max-width: 760px;
      color: rgba(255,255,255,0.72);
      font-size: 18px;
      line-height: 1.65;
      font-weight: 400;
      letter-spacing: 0.2px;
    }

    .panel{
      margin: 0 auto;
      max-width: 900px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 20px;
      padding: 18px;
      text-align: left;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
    }

    .label{
      font-size: 14px;
      letter-spacing: -0.01em;
      color: rgba(255,255,255,0.78);
      margin: 0 0 12px;
      font-weight: 600;
    }

    /* CHAT */
    .chat{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.20);
      overflow: hidden;
    }

    .messages{
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 360px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,0.2) transparent;
    }

    .bubble{
      max-width: 86%;
      border-radius: 16px;
      padding: 12px 14px;
      font-size: 17px;
      line-height: 1.55;
      letter-spacing: 0.1px;
      white-space: pre-wrap;
    }

    .bubble.user{
      align-self: flex-end;
      background: rgba(255,255,255,0.92);
      color: #1a1a1a;
      border: 1px solid rgba(255,255,255,0.22);
      border-bottom-right-radius: 6px;
    }

    .bubble.bot{
      align-self: flex-start;
      background: rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.94);
      border: 1px solid rgba(255,255,255,0.10);
      border-bottom-left-radius: 6px;
    }

    .composer{
      padding: 14px;
      border-top: 1px solid rgba(255,255,255,0.12);
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .textbox{
      flex: 1;
      min-width: 220px;
      min-height: 52px;
      max-height: 140px;
      resize: vertical;
      padding: 14px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.22);
      color: rgba(255,255,255,0.92);
      outline: none;
      font-family: 'EB Garamond', Georgia, serif;
      font-size: 18px;
      line-height: 1.55;
    }

    .textbox::placeholder{
      color: rgba(255,255,255,0.45);
    }

    .cta{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 16px 30px;
      border-radius: 999px;
      background: #ffffff;
      color: #1a1a1a;
      text-decoration: none;
      font-weight: 600;
      border: none;
      font-size: 16px;
      cursor: pointer;
      transition: all 200ms ease;
      position: relative;
      font-family: 'EB Garamond', Georgia, serif;
      white-space: nowrap;
    }

    .cta:hover{
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(0,0,0,0.2);
    }

    .cta:disabled{
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .cta svg{ width: 20px; height: 20px; }

    .note{
      color: rgba(255,255,255,0.68);
      font-size: 13px;
      line-height: 1.5;
      margin: 10px 2px 0;
    }

    .note strong{
      color: rgba(255,255,255,0.95);
      font-weight: 700;
    }

    /* CONTENT */
    .content{
      padding: 56px 0 110px;
      background: #ffffff;
    }

    .section-head{
      max-width: 900px;
      margin: 0 auto 18px;
      padding: 0 6px;
    }

    .section-head h2{
      font-size: 26px;
      letter-spacing: -0.02em;
      margin: 0 0 10px;
      font-weight: 700;
      color: var(--ink);
    }

    .section-head p{
      margin: 0;
      color: rgba(10,10,11,0.72);
      font-size: 15px;
      line-height: 1.7;
    }

    /* GRID */
    .grid{
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 24px;
      margin-top: 20px;
    }

    .card{
      background: #f5f5f5;
      border-radius: 12px;
      padding: 28px;
      cursor: pointer;
      transition: transform 200ms ease, box-shadow 200ms ease;
      display: flex;
      flex-direction: column;
      gap: 16px;
      min-height: 240px;
      position: relative;
      overflow: hidden;
    }

    .card:hover{
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(10,10,11,0.1);
    }

    .card-top{
      display: flex;
      align-items: center;
      gap: 14px;
      min-width: 0;
    }

    .doc-icon{
      width: 48px;
      height: 48px;
      border-radius: 10px;
      background: rgba(26,26,26,0.08);
      border: 1px solid rgba(26,26,26,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 auto;
    }

    .doc-icon svg{
      width: 24px;
      height: 24px;
      stroke: var(--ink);
      stroke-width: 1.4;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .meta{
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }

    .name{
      font-weight: 600;
      font-size: 13px;
      color: var(--ink);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tag{
      font-size: 11px;
      color: var(--muted);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .title{
      font-weight: 700;
      letter-spacing: -0.01em;
      font-size: 18px;
      line-height: 1.3;
      margin: 0;
      color: var(--ink);
    }

    .preview{
      margin: 0;
      color: rgba(10,10,11,0.72);
      font-size: 14px;
      line-height: 1.55;
      flex: 1;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
    }

    .empty{
      max-width: 900px;
      margin: 0 auto;
      padding: 18px 20px;
      border-radius: 16px;
      background: rgba(230,230,230,0.55);
      border: 1px solid rgba(200,200,200,0.55);
      color: rgba(10,10,11,0.78);
      font-size: 15px;
      line-height: 1.7;
      text-align: center;
    }

    /* MODAL */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 9999;
      backdrop-filter: blur(4px);
    }

    .modal{
      width: min(900px, 100%);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 32px;
      border: 1px solid rgba(255,255,255,0.5);
      box-shadow: 0 32px 96px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.8);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      max-height: 90vh;
    }

    .modal-head{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 24px 28px;
      border-bottom: 1px solid rgba(10,10,11,0.08);
      gap: 16px;
    }

    .modal-head .left{
      display: flex;
      align-items: center;
      gap: 14px;
      min-width: 0;
    }

    .modal-title{
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }

    .modal-title strong{
      font-size: 15px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 600;
    }

    .modal-title span{
      font-size: 11px;
      color: var(--muted);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .icon-btn{
      appearance: none;
      border: 1px solid rgba(10,10,11,0.12);
      background: rgba(255,255,255,0.5);
      border-radius: 999px;
      padding: 10px 16px;
      cursor: pointer;
      transition: all 200ms ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      color: var(--ink);
      font-size: 13px;
      flex: 0 0 auto;
      backdrop-filter: blur(10px);
      font-family: 'EB Garamond', Georgia, serif;
      text-decoration: none;
    }

    .icon-btn:hover{
      background: rgba(255,255,255,0.7);
      border-color: rgba(10,10,11,0.18);
    }

    .icon-btn svg{ width: 18px; height: 18px; }

    .modal-body{
      padding: 28px;
      overflow-y: auto;
      flex: 1;
    }

    .work-h1{
      margin: 0 0 14px;
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -0.02em;
      line-height: 1.25;
    }

    .work-text{
      margin: 0;
      font-size: 15px;
      line-height: 1.8;
      color: rgba(10,10,11,0.82);
      white-space: pre-wrap;
    }

    .modal-footer{
      padding: 18px 28px 22px;
      border-top: 1px solid rgba(10,10,11,0.08);
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 12px;
      flex-wrap: wrap;
    }

    .tiny-heart{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
      border-radius: 999px;
      border: none;
      background: transparent;
      cursor: pointer;
      user-select: none;
      color: var(--muted);
      transition: all 200ms ease;
    }

    .tiny-heart:hover{ color: #d11b2a; }

    .tiny-heart svg{
      width: 20px;
      height: 20px;
      fill: transparent;
      stroke: currentColor;
      stroke-width: 1.8;
      transition: fill 150ms ease, stroke 150ms ease;
    }

    .tiny-heart.liked{ color: #d11b2a; }
    .tiny-heart.liked svg{ fill: #d11b2a; stroke: #d11b2a; }

    /* RESPONSIVE */
    @media (max-width: 768px){
      .hero{ padding: 64px 0 56px; }
      .hero h1{ font-size: clamp(36px, 5vw, 48px); }
      .content{ padding: 44px 0 70px; }
      .grid{ grid-template-columns: 1fr; }
      .modal{ border-radius: 24px; }
      .card{ border-radius: 24px; padding: 20px; }
      .panel{ padding: 14px; border-radius: 18px; }
      .textbox{ font-size: 16px; }
      .bubble{ font-size: 16px; }
    }

    @media (max-width: 500px){
      .hero{ padding: 54px 0 48px; }
      .hero p{ font-size: 14px; }
      .cta{ padding: 14px 22px; font-size: 14px; width: 100%; }
      .card{ padding: 18px; border-radius: 20px; }
      .modal-body{ padding: 20px; }
      .work-h1{ font-size: 24px; }
      .work-text{ font-size: 14px; }
      .modal-head{ padding: 20px 22px; }
      .composer{ align-items: stretch; }
      .textbox{ width: 100%; }
    }
  </style>
</head>

<body>
  <!-- HERO -->
  <section class="hero">
    <div class="wrap">
      <div class="hero-inner">
        <div class="chip">Resource Navigator</div>

        <h1>Find support that actually fits</h1>

        <p>
          This is a private, conversational guide built for fatherless teens who want something more precise than generic links.
          Tell the navigator what is happening, what you are hoping for, and what kind of support feels realistic right now.
          It will respond thoughtfully and recommend a short list of vetted resources, chosen for fit, not volume.
          <br><br>
          If you are in immediate danger, or thinking about harming yourself, call or text <strong>988</strong> right now.
          This tool is not a crisis service.
        </p>

        <div class="panel">
          <p class="label">Tell me what you’re carrying right now, in your own words.</p>

          <div class="chat" aria-label="Resource Navigator chat">
            <div id="messages" class="messages" aria-live="polite"></div>

            <div class="composer">
              <textarea
                id="message"
                class="textbox"
                placeholder="Example: I feel angry about my dad. I want someone safe to talk to, and I want options that feel realistic for a teen."
              ></textarea>

              <button id="go" class="cta" type="button">
                <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                Send
              </button>

              <button id="clear" class="cta" type="button" style="background: rgba(255,255,255,0.12); color: rgba(255,255,255,0.92); border: 1px solid rgba(255,255,255,0.14);">
                New chat
              </button>
            </div>
          </div>

          <p class="note">
            Tip: The clearer you are about what you want (someone to talk to, coping skills, grief support, mentorship, a community, therapy options), the better the match.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- CONTENT -->
  <section class="content">
    <div class="wrap">
      <div class="section-head">
        <h2>Recommended resources</h2>
        <p>
          When the navigator suggests resources, they appear here as well, so they are easy to revisit.
          Click any card to see the full rationale and the direct link.
        </p>
      </div>

      <div id="status" class="empty">Start a conversation above, and your best matches will appear here.</div>
      <div id="grid" class="grid" aria-live="polite"></div>
    </div>
  </section>

  <!-- MODAL -->
  <div id="backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modal-head">
        <div class="left">
          <div class="doc-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
              <polyline points="13 2 13 9 20 9"></polyline>
            </svg>
          </div>
          <div class="modal-title">
            <strong id="mTitleSmall">Resource</strong>
            <span id="mTag">Vetted Resource</span>
          </div>
        </div>

        <button id="closeBtn" class="icon-btn" type="button" aria-label="Close">
          <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          Close
        </button>
      </div>

      <div class="modal-body">
        <h2 id="mTitle" class="work-h1">Title</h2>
        <p id="mText" class="work-text"></p>
      </div>

      <div class="modal-footer">
        <button id="heartBtn" class="tiny-heart" type="button" aria-pressed="false" title="Like">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
          </svg>
        </button>

        <a id="visitLink" class="icon-btn" href="#" target="_blank" rel="noopener">
          <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 3h7v7"></path>
            <path d="M10 14L21 3"></path>
            <path d="M21 14v7H3V3h7"></path>
          </svg>
          Visit site
        </a>
      </div>
    </div>
  </div>

  <script>
    const elMessage = document.getElementById("message");
    const elGo = document.getElementById("go");
    const elClear = document.getElementById("clear");
    const messages = document.getElementById("messages");
    const grid = document.getElementById("grid");
    const statusBox = document.getElementById("status");

    const backdrop = document.getElementById("backdrop");
    const closeBtn = document.getElementById("closeBtn");
    const mTitleSmall = document.getElementById("mTitleSmall");
    const mTag = document.getElementById("mTag");
    const mTitle = document.getElementById("mTitle");
    const mText = document.getElementById("mText");
    const heartBtn = document.getElementById("heartBtn");
    const visitLink = document.getElementById("visitLink");

    let conversation = [];
    let lastResources = [];
    let currentCard = null;

    function escapeHtml(str){
      return (str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function setStatus(msg){
      statusBox.style.display = "block";
      statusBox.textContent = msg;
    }

    function clearStatus(){
      statusBox.style.display = "none";
      statusBox.textContent = "";
    }

    function scrollChat(){
      messages.scrollTop = messages.scrollHeight;
    }

    function addBubble(role, text){
      const div = document.createElement("div");
      div.className = "bubble " + (role === "user" ? "user" : "bot");
      div.textContent = text;
      messages.appendChild(div);
      scrollChat();
    }

    function formatConversationForApi(){
      // Lightweight context without requiring backend changes.
      const tail = conversation.slice(-8);
      return tail.map(m => `${m.role === "user" ? "User" : "Assistant"}: ${m.text}`).join("\n");
    }

    function normalizeResource(r){
      const title = r.title || r.name || "Resource";
      const url = r.url || r.website || "";
      const why = r.why || r.reason || r.description || "";
      const tag = (r.tag || r.type || "Vetted Resource");

      const preview = (why || "").trim();
      const previewShort = preview.length > 170 ? preview.slice(0, 170).trim() + "…" : preview;

      const details =
        `${preview}\n\n` +
        (url ? `Website: ${url}` : "");

      return {
        id: (r.id || title + "|" + url),
        title,
        url,
        tag,
        preview: previewShort || "Click to see what this is best for and how to use it.",
        details: details.trim() || "No additional details provided."
      };
    }

    function renderCards(list){
      if (!list || list.length === 0){
        grid.innerHTML = "";
        setStatus("No matches yet. Send a message above, and your best matches will appear here.");
        return;
      }

      clearStatus();

      grid.innerHTML = list.map(item => `
        <article class="card" data-id="${escapeHtml(item.id)}" tabindex="0" role="button" aria-label="Open ${escapeHtml(item.title)}">
          <div class="card-top">
            <div class="doc-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24">
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                <polyline points="13 2 13 9 20 9"></polyline>
              </svg>
            </div>
            <div class="meta">
              <div class="name">${escapeHtml(item.title)}</div>
              <div class="tag">${escapeHtml(item.tag)}</div>
            </div>
          </div>
          <h3 class="title">${escapeHtml(item.title)}</h3>
          <p class="preview">${escapeHtml(item.preview)}</p>
        </article>
      `).join("");

      Array.from(document.querySelectorAll(".card")).forEach(card => {
        card.addEventListener("click", () => openModal(card.dataset.id));
        card.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            openModal(card.dataset.id);
          }
        });
      });
    }

    function openModal(id){
      const found = (lastResources || []).find(x => x.id === id);
      if (!found) return;

      currentCard = found;

      mTitleSmall.textContent = found.title;
      mTag.textContent = (found.tag || "Vetted Resource").toUpperCase();
      mTitle.textContent = found.title;
      mText.textContent = found.details;

      if (found.url){
        visitLink.href = found.url;
        visitLink.style.display = "inline-flex";
      } else {
        visitLink.href = "#";
        visitLink.style.display = "none";
      }

      backdrop.style.display = "flex";
      backdrop.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
      closeBtn.focus();
    }

    function closeModal(){
      backdrop.style.display = "none";
      backdrop.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      currentCard = null;
    }

    closeBtn.addEventListener("click", closeModal);
    backdrop.addEventListener("click", (e) => { if (e.target === backdrop) closeModal(); });
    window.addEventListener("keydown", (e) => { if (e.key === "Escape" && backdrop.style.display === "flex") closeModal(); });

    heartBtn.addEventListener("click", () => {
      heartBtn.classList.toggle("liked");
      heartBtn.setAttribute("aria-pressed", heartBtn.classList.contains("liked") ? "true" : "false");
    });

    function setSending(isSending){
      elGo.disabled = isSending;
      if (isSending){
        elGo.textContent = "Thinking…";
      } else {
        elGo.innerHTML = `
          <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          Send
        `;
      }
    }

    async function send(){
      const raw = (elMessage.value || "").trim();
      if (!raw){
        addBubble("bot", "If you want, start with one sentence. What has been hardest recently?");
        return;
      }

      // Optimistic UI
      elMessage.value = "";
      conversation.push({ role: "user", text: raw });
      addBubble("user", raw);

      setSending(true);

      try{
        // Send lightweight context so the backend can answer like a chatbot even if it’s stateless.
        const contextual = formatConversationForApi();

        const res = await fetch("/api/navigate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: contextual
          })
        });

        const data = await res.json();
        if (!res.ok){
          throw new Error(data?.error || "Request failed");
        }

        const intro = (data.intro || "").trim();
        const mode = (data.mode || "recommendations").trim();

        // Chat response
        if (intro){
          conversation.push({ role: "assistant", text: intro });
          addBubble("bot", intro);
        } else {
          const fallback = "I’m here. Tell me a little more about what you want most right now, and I’ll narrow it down carefully.";
          conversation.push({ role: "assistant", text: fallback });
          addBubble("bot", fallback);
        }

        // Resources (aim for 3, but frontend will show whatever backend returns)
        const list = Array.isArray(data.resources) ? data.resources : [];
        lastResources = list.map(normalizeResource);

        if (lastResources.length){
          // A short, elegant bridge line in-chat, then cards below.
          const bridge =
            lastResources.length === 1
              ? "Here is one strong match, chosen for fit."
              : "Here are the strongest matches, chosen for fit, not volume.";

          conversation.push({ role: "assistant", text: bridge });
          addBubble("bot", bridge);

          // Also show the resources in-chat, clearly, with links.
          lastResources.forEach((r, i) => {
            const block =
              `${i + 1}. ${r.title}\n` +
              `${r.preview}\n` +
              (r.url ? `Website: ${r.url}` : "");
            conversation.push({ role: "assistant", text: block });
            addBubble("bot", block);
          });
        } else {
          const none =
            "I’m not seeing a clean match from the current resource list yet. If you tell me one detail more, I can narrow it down, for example: do you want someone to talk to, practical coping tools, a mentor, or professional support?";
          conversation.push({ role: "assistant", text: none });
          addBubble("bot", none);
        }

        // Render cards in the white section
        renderCards(lastResources);
        clearStatus();

        // Optional: keep track of mode if your backend uses it later.
        void mode;

      } catch (err){
        addBubble("bot", "Something went wrong while fetching matches. If you are testing, check Vercel Runtime Logs for /api/navigate and confirm your environment variables are set.");
      } finally {
        setSending(false);
      }
    }

    function resetChat(){
      conversation = [];
      messages.innerHTML = "";

      addBubble("bot",
        "You can start anywhere. If it helps, tell me what you are feeling, what you want, and what kind of support feels realistic right now."
      );

      lastResources = [];
      grid.innerHTML = "";
      setStatus("Start a conversation above, and your best matches will appear here.");
    }

    elGo.addEventListener("click", send);
    elClear.addEventListener("click", resetChat);

    elMessage.addEventListener("keydown", (e) => {
      // Enter sends, Shift+Enter adds a new line.
      if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });

    // Initial
    resetChat();
  </script>
</body>
</html>
