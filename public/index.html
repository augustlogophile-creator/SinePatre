<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Youth Fatherless Network — Resource Navigator</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=EB+Garamond:wght@400;500;600;700&display=swap');

    :root{
      --bg0: #071b2f;          /* dark navy */
      --bg1: #061427;          /* deeper */
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.10);
      --stroke2: rgba(255,255,255,0.14);

      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.68);

      --chip: rgba(255,255,255,0.07);
      --chipStroke: rgba(255,255,255,0.10);

      --blue: #2f7af5;
      --blueHover: #2466d2;

      --dangerBg: rgba(234, 84, 85, 0.14);
      --dangerStroke: rgba(234, 84, 85, 0.35);
      --dangerText: rgba(234, 84, 85, 0.95);

      --radius-xl: 22px;
      --radius-lg: 18px;
      --radius-md: 14px;
    }

    *{ box-sizing:border-box; }

    html, body{
      height:100%;
      margin:0;
      padding:0;
    }

    body{
      font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1100px 700px at 50% 20%, rgba(255,255,255,0.06), transparent 60%),
        radial-gradient(900px 600px at 15% 10%, rgba(47,122,245,0.10), transparent 55%),
        radial-gradient(900px 700px at 85% 5%, rgba(47,122,245,0.08), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .app{
      min-height:100vh;
      position:relative;
    }

    .center{
      width: min(980px, 100%);
      margin: 0 auto;
      padding: 0 20px;
    }

    /* LANDING */
    .landing{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 40px 0 200px; /* leave room for composer */
    }

    .brand{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Helvetica, Arial, sans-serif;
      font-weight: 500;
      letter-spacing: -0.02em;
      font-size: clamp(40px, 6.2vw, 74px);
      margin: 0 0 14px;
      color: rgba(255,255,255,0.88);
      text-shadow: 0 20px 60px rgba(0,0,0,0.45);
    }

    .desc{
      max-width: 760px;
      margin: 0 auto;
      font-size: 16px;
      line-height: 1.8;
      color: var(--muted);
    }

    .desc strong{
      color: rgba(255,255,255,0.86);
      font-weight: 600;
    }

    /* CHAT */
    .chat{
      display:none;
      padding: 22px 0 160px; /* space for fixed composer */
    }
    .chat.active{ display:block; }

    .messages{
      display:flex;
      flex-direction:column;
      gap: 18px;
    }

    .msg-row{
      display:flex;
      animation: slideIn 0.18s ease-out;
    }
    .msg-row.user{ justify-content:flex-end; }
    .msg-row.assistant{ justify-content:flex-start; }

    @keyframes slideIn{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0); }
    }

    .bubble{
      max-width: min(820px, 96%);
      border-radius: var(--radius-lg);
      line-height: 1.75;
      font-size: 16px;
      word-wrap: break-word;
      overflow-wrap: anywhere;
    }

    .bubble.user{
      padding: 14px 16px;
      background: rgba(255,255,255,0.07);
      border: 1px solid rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.92);
      box-shadow: 0 18px 45px rgba(0,0,0,0.28);
    }

    .bubble.assistant{
      padding: 0;
      background: transparent;
      border: none;
      color: rgba(255,255,255,0.90);
    }

    /* Assistant rich block */
    .rec-wrap{
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius-xl);
      padding: 16px 16px 8px;
      box-shadow: 0 22px 70px rgba(0,0,0,0.30);
    }

    .rec-intro{
      margin: 0 0 10px;
      color: rgba(255,255,255,0.86);
      font-size: 16px;
      line-height: 1.7;
    }

    .rec-card{
      background: rgba(255,255,255,0.045);
      border: 1px solid rgba(255,255,255,0.09);
      border-radius: 18px;
      padding: 14px 14px 12px;
      margin: 10px 0 0;
    }

    .rec-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 8px;
    }

    .rec-title strong{
      font-family: "EB Garamond", Georgia, "Times New Roman", serif;
      font-weight: 700;
      letter-spacing: -0.01em;
      font-size: 20px;
      color: rgba(255,255,255,0.92);
      margin: 0;
    }

    .rec-link{
      color: rgba(255,255,255,0.86);
      text-decoration: underline;
      text-underline-offset: 3px;
      text-decoration-thickness: 1px;
      font-weight: 600;
      font-size: 13px;
      opacity: 0.9;
      white-space: nowrap;
    }
    .rec-link:hover{
      opacity: 1;
      text-decoration-thickness: 2px;
    }

    .rec-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 6px;
    }

    .rec-row{
      color: rgba(255,255,255,0.80);
      font-size: 15px;
      line-height: 1.7;
    }
    .rec-row b{
      color: rgba(255,255,255,0.92);
      font-weight: 700;
    }

    /* COMPOSER (fixed) */
    .composer-shell{
      position: fixed;
      left:0;
      right:0;
      bottom:0;
      padding: 18px 0 22px;
      z-index: 50;
      pointer-events: none; /* allow only inner to receive clicks */
      background: linear-gradient(180deg, transparent, rgba(0,0,0,0.22));
    }
    .composer-shell .center{ pointer-events: auto; }

    .input-shell{
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      backdrop-filter: blur(10px);
      box-shadow: 0 30px 80px rgba(0,0,0,0.35);
      overflow:hidden;
    }

    .input-top{
      display:grid;
      grid-template-columns: 1fr auto auto;
      gap: 12px;
      align-items:center;
      padding: 14px 14px;
    }

    textarea{
      width:100%;
      border:none;
      outline:none;
      background: transparent;
      color: rgba(255,255,255,0.92);
      font-size: 16px;
      line-height: 1.5;
      resize:none;
      min-height: 26px;
      max-height: 120px;
      padding: 2px 0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Helvetica, Arial, sans-serif;
    }
    textarea::placeholder{ color: rgba(255,255,255,0.50); }

    .icon-btn{
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: all 0.18s ease;
      user-select:none;
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.85);
    }
    .icon-btn:hover{ background: rgba(255,255,255,0.09); border-color: rgba(255,255,255,0.14); }
    .icon-btn:disabled{ opacity:0.55; cursor:not-allowed; }

    .danger-btn{
      background: var(--dangerBg);
      border-color: var(--dangerStroke);
      color: var(--dangerText);
    }
    .danger-btn:hover{
      background: rgba(234, 84, 85, 0.20);
      border-color: rgba(234, 84, 85, 0.45);
    }

    .send-btn{
      background: rgba(255,255,255,0.90);
      color: rgba(0,0,0,0.86);
      border-color: rgba(255,255,255,0.95);
    }
    .send-btn:hover{
      background: rgba(255,255,255,0.98);
      border-color: rgba(255,255,255,1);
    }

    .icon-btn svg{
      width: 18px;
      height: 18px;
      stroke: currentColor;
      stroke-width: 2.2;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .input-bottom{
      padding: 10px 14px 12px;
      border-top: 1px solid rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.46);
      font-size: 12.5px;
      line-height: 1.4;
      min-height: 22px; /* prevents layout jump without creating a “bar” */
    }

    .status{
      display:none;
    }
    .status.show{
      display:block;
    }

    /* Responsive */
    @media (max-width: 640px){
      .center{ padding: 0 14px; }
      .landing{ padding-bottom: 220px; }
      .desc{ font-size: 15px; }
      .rec-title strong{ font-size: 19px; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar{ width: 6px; }
    ::-webkit-scrollbar-track{ background: transparent; }
    ::-webkit-scrollbar-thumb{ background: rgba(255,255,255,0.12); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,0.18); }
  </style>
</head>

<body>
  <div class="app">
    <div class="center">
      <section id="landing" class="landing" aria-label="Landing">
        <h1 class="brand">Youth Fatherless Network</h1>
        <p class="desc">
          Describe what you need, and this tool will chat with you to help locate the most relevant resources from
          <strong>YFN’s database</strong>. You can ask follow-up questions, and it will return the best matches with links.
        </p>
      </section>

      <section id="chat" class="chat" aria-label="Chat">
        <div id="messages" class="messages" aria-live="polite" aria-label="Chat messages"></div>
      </section>
    </div>

    <!-- Fixed composer -->
    <div class="composer-shell" aria-label="Message composer">
      <div class="center">
        <div class="input-shell">
          <div class="input-top">
            <textarea
              id="input"
              placeholder="Ask anything…"
              rows="1"
              autocomplete="off"
              spellcheck="true"
            ></textarea>

            <!-- Crisis button -->
            <button id="help-btn" class="icon-btn danger-btn" type="button" title="Teen Line (immediate support)">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 9v4" />
                <path d="M12 17h.01" />
                <path d="M10.3 4.6 2.6 18a2 2 0 0 0 1.7 3h15.4a2 2 0 0 0 1.7-3L13.7 4.6a2 2 0 0 0-3.4 0Z"/>
              </svg>
            </button>

            <!-- Send -->
            <button id="send-btn" class="icon-btn send-btn" type="button" title="Send">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M5 12h14" />
                <path d="M12 5l7 7-7 7" />
              </svg>
            </button>
          </div>

          <div class="input-bottom">
            <div id="status" class="status"></div>
            <div id="hint">Enter to send, Shift + Enter for a new line.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const landingEl = document.getElementById('landing');
    const chatEl = document.getElementById('chat');
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send-btn');
    const helpBtn = document.getElementById('help-btn');
    const statusEl = document.getElementById('status');

    let history = [];
    let started = false;

    function autoGrowTextarea(){
      inputEl.style.height = 'auto';
      inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px';
    }

    function startChatLayoutIfNeeded(){
      if (started) return;
      started = true;
      landingEl.style.display = 'none';
      chatEl.classList.add('active');
    }

    function setStatus(text){
      const t = String(text || '').trim();
      if (!t){
        statusEl.textContent = '';
        statusEl.classList.remove('show');
        return;
      }
      statusEl.textContent = t;
      statusEl.classList.add('show');
    }

    function scrollToBottom(){
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'instant' });
    }

    function addMessage(role, content){
      const row = document.createElement('div');
      row.className = `msg-row ${role}`;

      const bubble = document.createElement('div');
      bubble.className = `bubble ${role}`;

      // Default: plain text
      bubble.textContent = String(content || '');

      row.appendChild(bubble);
      messagesEl.appendChild(row);
      scrollToBottom();
      return row;
    }

    function addRecommendations(payload){
      const row = document.createElement('div');
      row.className = 'msg-row assistant';

      const bubble = document.createElement('div');
      bubble.className = 'bubble assistant';

      const wrap = document.createElement('div');
      wrap.className = 'rec-wrap';

      if (payload.intro){
        const intro = document.createElement('p');
        intro.className = 'rec-intro';
        intro.textContent = payload.intro;
        wrap.appendChild(intro);
      }

      const items = Array.isArray(payload.items) ? payload.items : [];

      for (const item of items){
        const card = document.createElement('div');
        card.className = 'rec-card';

        const titleRow = document.createElement('div');
        titleRow.className = 'rec-title';

        const title = document.createElement('strong');
        title.textContent = item.title || 'Resource';

        const link = document.createElement('a');
        link.className = 'rec-link';
        link.href = item.url || '#';
        link.target = '_blank';
        link.rel = 'noopener';
        link.textContent = 'Open link';

        titleRow.appendChild(title);
        titleRow.appendChild(link);
        card.appendChild(titleRow);

        const grid = document.createElement('div');
        grid.className = 'rec-grid';

        const d = document.createElement('div');
        d.className = 'rec-row';
        d.innerHTML = '<b>Description:</b> ' + escapeHtml(item.description || '');

        const w = document.createElement('div');
        w.className = 'rec-row';
        w.innerHTML = '<b>Why it matches what you’re looking for:</b> ' + escapeHtml(item.why || '');

        const n = document.createElement('div');
        n.className = 'rec-row';
        n.innerHTML = '<b>Next steps:</b> ' + escapeHtml(item.next_steps || '');

        grid.appendChild(d);
        grid.appendChild(w);
        grid.appendChild(n);
        card.appendChild(grid);

        wrap.appendChild(card);
      }

      bubble.appendChild(wrap);
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      scrollToBottom();
      return row;
    }

    function escapeHtml(str){
      return String(str || '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    async function send(){
      const msg = inputEl.value.trim();
      if (!msg) return;

      startChatLayoutIfNeeded();
      addMessage('user', msg);

      inputEl.value = '';
      inputEl.style.height = 'auto';

      sendBtn.disabled = true;
      setStatus('Thinking…');

      history.push({ role: 'user', content: msg });

      // Show a temporary assistant line
      const pendingRow = addMessage('assistant', 'Thinking…');

      try{
        const res = await fetch('/api/navigate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: msg,
            history,
            age: '',
            topics: []
          }),
        });

        const data = await res.json().catch(() => ({}));

        // Remove the pending row
        pendingRow.remove();

        if (!res.ok || data.error){
          const detail = (data && (data.detail || data.hint)) ? ` ${data.detail || data.hint}` : '';
          addMessage('assistant', 'Something went wrong.' + detail);
          setStatus('');
        } else {
          // Prefer structured recommendations when available
          if (data && Array.isArray(data.items) && data.items.length){
            addRecommendations(data);
          } else {
            const text = (data && (data.intro || data.response)) ? String(data.intro || data.response) : 'I did not get a usable response. Try again.';
            addMessage('assistant', text);
          }
          setStatus('');
          // Keep history consistent as plain text for the model
          if (data && Array.isArray(data.items) && data.items.length){
            const compact = data.items.map(x => `${x.title}: ${x.url}`).join(' | ');
            history.push({ role: 'assistant', content: (data.intro ? data.intro + ' ' : '') + compact });
          } else {
            history.push({ role: 'assistant', content: String((data.intro || data.response) || '').trim() });
          }
        }
      } catch (err){
        pendingRow.remove();
        addMessage('assistant', 'Connection error. Open DevTools → Network and confirm /api/navigate returns JSON.');
        setStatus('');
      }

      sendBtn.disabled = false;
      inputEl.focus();
    }

    // Buttons must work
    sendBtn.addEventListener('click', () => send());
    helpBtn.addEventListener('click', () => {
      window.open('https://didihirsch.org/teenline/', '_blank', 'noopener');
    });

    inputEl.addEventListener('input', autoGrowTextarea);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });

    autoGrowTextarea();
    inputEl.focus();
  </script>
</body>
</html>
