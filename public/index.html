<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Youth Fatherless Network — Resource Navigator</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');

    :root{
      --navy: #071a2f;          /* solid background */
      --panel: rgba(255,255,255,0.06);
      --panel-2: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --muted-2: rgba(255,255,255,0.55);
      --chip: rgba(255,255,255,0.07);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius-xl: 22px;
      --radius-lg: 18px;
      --radius-md: 14px;

      --danger-bg: rgba(255, 90, 90, 0.12);
      --danger-bd: rgba(255, 90, 90, 0.28);
      --danger: rgba(255, 120, 120, 0.9);

      --send-bg: rgba(255,255,255,0.92);
      --send-text: rgba(0,0,0,0.82);
    }

    * { box-sizing: border-box; }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: var(--navy);
    }

    body{
      font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      color: var(--text);
      line-height: 1.55;
      letter-spacing: -0.01em;
      overflow-x: hidden;
    }

    .app{ min-height: 100vh; }

    .center{
      width: min(980px, 100%);
      margin: 0 auto;
      padding: 0 22px;
    }

    /* Landing */
    .landing{
      min-height: 100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 40px 0 210px;
    }

    .title{
      font-size: clamp(40px, 6vw, 64px);
      font-weight: 600;
      margin: 0 0 16px 0;
      letter-spacing: -0.03em;
    }

    .desc{
      max-width: 720px;
      margin: 0 auto;
      color: var(--muted);
      font-size: 16px;
      line-height: 1.8;
    }

    /* Chat */
    .chat{
      display:none;
      padding: 26px 0 210px;
    }
    .chat.active{ display:block; }

    .messages{
      display:flex;
      flex-direction:column;
      gap: 18px;
    }

    .msg-row{
      display:flex;
      animation: fadeUp 0.16s ease-out;
    }
    .msg-row.user{ justify-content:flex-end; }
    .msg-row.assistant{ justify-content:flex-start; }

    @keyframes fadeUp{
      from { opacity:0; transform: translateY(6px); }
      to { opacity:1; transform: translateY(0); }
    }

    .bubble{
      max-width: min(720px, 96%);
      padding: 12px 16px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: var(--chip);
      color: var(--text);
      font-size: 16px;
      line-height: 1.7;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .bubble.user{
      background: rgba(255,255,255,0.07);
      border-color: rgba(255,255,255,0.12);
    }

    .bubble.assistant{
      background: transparent;
      border: none;
      padding: 0;
      max-width: min(860px, 100%);
    }

    /* Assistant blocks */
    .assistant-block{
      width: min(860px, 100%);
    }

    .assistant-intro{
      color: var(--text);
      margin: 0 0 12px 0;
      font-size: 16px;
      line-height: 1.75;
    }

    .cards{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: 18px 18px 16px;
      box-shadow: none;
    }

    .card-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 14px;
      margin-bottom: 8px;
    }

    .card-title{
      font-size: 18px;
      font-weight: 600;
      letter-spacing: -0.02em;
      margin: 0;
      color: rgba(255,255,255,0.95);
    }

    .open-link{
      color: rgba(255,255,255,0.75);
      text-decoration: underline;
      text-underline-offset: 3px;
      font-weight: 500;
      white-space: nowrap;
    }
    .open-link:hover{ color: rgba(255,255,255,0.92); }

    .card-line{
      margin-top: 10px;
      color: var(--muted);
      font-size: 15px;
      line-height: 1.7;
    }

    .card-line b{
      color: rgba(255,255,255,0.92);
      font-weight: 600;
    }

    .assistant-note{
      margin-top: 10px;
      color: var(--muted-2);
      font-size: 13px;
      line-height: 1.6;
    }

    /* Composer (no bar line, no gradient, no separator) */
    .composer-shell{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 18px 0 22px;
      background: transparent;
      border-top: none;
      z-index: 9999;
      pointer-events: none; /* allow only inner controls */
    }

    .composer-inner{
      pointer-events: auto;
    }

    .composer{
      width: min(860px, 100%);
      margin: 0 auto;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .composer-top{
      padding: 12px 14px;
      display:flex;
      gap: 10px;
      align-items: flex-end;
    }

    textarea{
      flex: 1;
      width: 100%;
      border: none;
      outline: none;
      background: transparent;
      color: var(--text);
      font-family: Inter, system-ui, sans-serif;
      font-size: 16px;
      line-height: 1.5;
      resize: none;
      min-height: 24px;
      max-height: 140px;
      padding: 6px 6px;
    }

    textarea::placeholder{
      color: rgba(255,255,255,0.55);
    }

    .icon-btn{
      width: 42px;
      height: 42px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform 0.08s ease, background 0.12s ease, border-color 0.12s ease;
      flex-shrink: 0;
      text-decoration:none;
      user-select:none;
    }

    .icon-btn:hover{
      background: rgba(255,255,255,0.09);
      border-color: rgba(255,255,255,0.18);
    }

    .icon-btn:active{ transform: scale(0.98); }

    .danger{
      background: var(--danger-bg);
      border-color: var(--danger-bd);
      color: var(--danger);
    }
    .danger:hover{
      background: rgba(255, 90, 90, 0.18);
      border-color: rgba(255, 90, 90, 0.34);
    }

    .send{
      background: var(--send-bg);
      border-color: rgba(255,255,255,0.9);
      color: var(--send-text);
    }
    .send:hover{
      background: rgba(255,255,255,0.96);
    }
    .send:disabled{
      opacity: 0.55;
      cursor: not-allowed;
    }

    .icon{
      width: 18px;
      height: 18px;
      display:block;
    }

    .composer-hint{
      padding: 0 16px 12px 16px;
      color: rgba(255,255,255,0.48);
      font-size: 13px;
    }

    .status{
      margin-top: 10px;
      color: rgba(255,255,255,0.65);
      font-size: 14px;
      min-height: 18px;
    }

    @media (max-width: 640px){
      .center{ padding: 0 16px; }
      .composer{ border-radius: 16px; }
      .landing{ padding-bottom: 230px; }
      .chat{ padding-bottom: 230px; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar{ width: 8px; }
    ::-webkit-scrollbar-track{ background: transparent; }
    ::-webkit-scrollbar-thumb{ background: rgba(255,255,255,0.10); border-radius: 999px; }
    ::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,0.16); }
  </style>
</head>

<body>
  <div class="app">
    <div class="center">
      <section id="landing" class="landing">
        <h1 class="title">Youth Fatherless Network</h1>
        <p class="desc">
          Describe what you need, and I’ll pull the best matching resources from Youth Fatherless Network’s database.
          You can ask follow-up questions, and I’ll help you narrow to the most relevant options.
        </p>
      </section>

      <section id="chat" class="chat" aria-label="Chat">
        <div id="messages" class="messages" aria-live="polite" aria-label="Chat messages"></div>
      </section>
    </div>

    <div class="composer-shell" aria-hidden="false">
      <div class="center composer-inner">
        <div class="composer" role="group" aria-label="Message composer">
          <div class="composer-top">
            <textarea
              id="input"
              placeholder="Ask anything…"
              rows="1"
              autocomplete="off"
              spellcheck="true"
            ></textarea>

            <a
              id="help-btn"
              href="https://didihirsch.org/teenline/"
              target="_blank"
              rel="noopener noreferrer"
              class="icon-btn danger"
              title="Teen Line (support)"
            >
              <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 9v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M12 17h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                <path d="M10.3 4.6a2 2 0 0 1 3.4 0l8 13.9A2 2 0 0 1 20 21H4a2 2 0 0 1-1.7-2.5l8-13.9Z" stroke="currentColor" stroke-width="1.6"/>
              </svg>
            </a>

            <button id="send-btn" class="icon-btn send" title="Send" type="button">
              <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M5 12h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M13 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>

          <div class="composer-hint">Enter to send, Shift + Enter for a new line.</div>
        </div>

        <div id="status" class="status"></div>
      </div>
    </div>
  </div>

  <script>
    const landingEl = document.getElementById('landing');
    const chatEl = document.getElementById('chat');
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send-btn');
    const statusEl = document.getElementById('status');

    let history = [];
    let started = false;

    function autoGrowTextarea() {
      inputEl.style.height = 'auto';
      inputEl.style.height = Math.min(inputEl.scrollHeight, 140) + 'px';
    }

    function startChatLayoutIfNeeded() {
      if (started) return;
      started = true;
      landingEl.style.display = 'none';
      chatEl.classList.add('active');
    }

    function scrollToBottom() {
      requestAnimationFrame(() => {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'instant' });
      });
    }

    function addUserMessage(content) {
      const row = document.createElement('div');
      row.className = 'msg-row user';

      const bubble = document.createElement('div');
      bubble.className = 'bubble user';
      bubble.textContent = String(content || '');

      row.appendChild(bubble);
      messagesEl.appendChild(row);
      scrollToBottom();
    }

    function addAssistantBlock({ intro = '', items = [], note = '' } = {}) {
      const row = document.createElement('div');
      row.className = 'msg-row assistant';

      const bubble = document.createElement('div');
      bubble.className = 'bubble assistant';

      const block = document.createElement('div');
      block.className = 'assistant-block';

      if (intro) {
        const p = document.createElement('p');
        p.className = 'assistant-intro';
        p.textContent = intro;
        block.appendChild(p);
      }

      if (Array.isArray(items) && items.length) {
        const cards = document.createElement('div');
        cards.className = 'cards';

        items.forEach((it) => {
          const card = document.createElement('div');
          card.className = 'card';

          const top = document.createElement('div');
          top.className = 'card-top';

          const title = document.createElement('h3');
          title.className = 'card-title';
          title.textContent = it.title || 'Resource';

          const link = document.createElement('a');
          link.className = 'open-link';
          link.href = it.url || '#';
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.textContent = 'Open link';

          top.appendChild(title);
          top.appendChild(link);

          const desc = document.createElement('div');
          desc.className = 'card-line';
          desc.innerHTML = '<b>Description:</b> ' + (escapeHTML(it.description || ''));

          const why = document.createElement('div');
          why.className = 'card-line';
          why.innerHTML = '<b>Why it matches what you’re looking for:</b> ' + (escapeHTML(it.why || ''));

          const next = document.createElement('div');
          next.className = 'card-line';
          next.innerHTML = '<b>Next steps:</b> ' + (escapeHTML(it.next_steps || ''));

          card.appendChild(top);
          card.appendChild(desc);
          card.appendChild(why);
          card.appendChild(next);

          cards.appendChild(card);
        });

        block.appendChild(cards);
      }

      if (note) {
        const n = document.createElement('div');
        n.className = 'assistant-note';
        n.textContent = note;
        block.appendChild(n);
      }

      bubble.appendChild(block);
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      scrollToBottom();
      return row;
    }

    function escapeHTML(str) {
      return String(str || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function setStatus(text) {
      statusEl.textContent = text || '';
    }

    async function send() {
      const msg = inputEl.value.trim();
      if (!msg) return;

      startChatLayoutIfNeeded();
      addUserMessage(msg);

      inputEl.value = '';
      inputEl.style.height = 'auto';
      sendBtn.disabled = true;
      setStatus('Working…');

      history.push({ role: 'user', content: msg });

      // placeholder
      const pending = addAssistantBlock({ intro: 'Working…' });

      try {
        const res = await fetch('/api/navigate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: msg, history })
        });

        const data = await res.json().catch(() => ({}));

        // remove placeholder
        pending.remove();

        if (!res.ok || data.error) {
          addAssistantBlock({
            intro: 'Something went wrong.',
            note: data?.detail ? String(data.detail) : ''
          });
          setStatus('');
        } else {
          // Expected: { intro, items[], note? }
          addAssistantBlock({
            intro: String(data.intro || '').trim(),
            items: Array.isArray(data.items) ? data.items : [],
            note: String(data.note || '').trim()
          });

          const assistantForHistory = buildHistoryTextFromResponse(data);
          history.push({ role: 'assistant', content: assistantForHistory });
          setStatus('');
        }
      } catch (err) {
        pending.remove();
        addAssistantBlock({
          intro: 'Connection error.',
          note: 'Open DevTools → Network and confirm /api/navigate returns JSON.'
        });
        setStatus('');
      }

      sendBtn.disabled = false;
      inputEl.focus();
    }

    function buildHistoryTextFromResponse(data) {
      const parts = [];
      if (data?.intro) parts.push(String(data.intro));
      if (Array.isArray(data?.items)) {
        for (const it of data.items.slice(0, 3)) {
          parts.push(`${it.title} (${it.url})`);
        }
      }
      if (data?.note) parts.push(String(data.note));
      return parts.join('\n');
    }

    inputEl.addEventListener('input', autoGrowTextarea);

    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    sendBtn.addEventListener('click', () => send());

    autoGrowTextarea();
    inputEl.focus();
  </script>
</body>
</html>
